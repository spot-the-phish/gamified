<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spot the Phish Game</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f4f4f9; color: #333; }
    .card { background: white; border-radius: 10px; padding: 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h1 { color: #0074cc; margin-bottom: 20px; }
    .buttons { margin: 15px; }
    button { margin: 5px; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
    .phish { background: #e63946; color: white; }
    .legit { background: #2a9d8f; color: white; }
    .feedback { margin: 15px; font-weight: bold; }
    #score { margin-top: 25px; font-size: 18px; }
    .email-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; }
    .avatar { background: #d33c3c; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
    .meta { font-size: 14px; }
    .subject-line { font-size: 18px; font-weight: bold; padding: 10px; border-bottom: 1px solid #ddd; }
    .email-body-frame { width: 100%; height: 500px; border: none; }
  </style>
</head>
<body>
  <h1>Spot the Phish üêü</h1>
  <div id="game"></div>
  <div id="score"></div>

  <script>
    let emails = [];
    let current = 0;
    let score = 0;

    // ‚úÖ Files to load from /emails/
    const emailFiles = ["phish1.eml","legit1.eml","legit4.eml"];

    // ‚úÖ Answer key
    const answerKey = {
      "phish1.eml": "phish",
      "legit1.eml": "legit",
      "legit4.eml": "legit"
    };

    // --- Helpers ---
    function decodeQuotedPrintable(input) {
      let text = input.replace(/=\r?\n/g, "");
      let bytes = text.replace(/=([A-Fa-f0-9]{2})/g, (_, hex) =>
        String.fromCharCode(parseInt(hex, 16))
      );
      try { return decodeURIComponent(escape(bytes)); } catch (e) { return bytes; }
    }

    function decodeMimeWords(str) {
      return str
        .replace(/=\?UTF-8\?B\?(.+?)\?=/gi, (_, b64) => {
          try { return decodeURIComponent(escape(atob(b64))); } catch { return b64; }
        })
        .replace(/=\?UTF-8\?Q\?(.+?)\?=/gi, (_, qp) => {
          return qp.replace(/_/g, " ").replace(/=([A-Fa-f0-9]{2})/g, (_, hex) =>
            String.fromCharCode(parseInt(hex, 16))
          );
        });
    }

    function parseMimeParts(content, boundary) {
      const parts = content.split("--" + boundary).filter(p => p.trim() && !p.startsWith("--"));
      return parts.map(part => {
        const [rawHeaders, ...bodyLines] = part.split(/\r?\n\r?\n/);
        const headers = {};
        rawHeaders.split(/\r?\n/).forEach(line => {
          const [name, ...rest] = line.split(":");
          if (name && rest.length) headers[name.trim().toLowerCase()] = rest.join(":").trim();
        });
        return { headers, body: bodyLines.join("\n") };
      });
    }

    function parseEml(content, filename) {
      // Headers
      const headerSection = content.split(/\r?\n\r?\n/)[0];
      const subjectMatch = headerSection.match(/^Subject:\s*(.*)$/mi);
      let subject = subjectMatch ? subjectMatch[1].trim() : "(No Subject)";
      subject = decodeMimeWords(subject);

      const fromMatch = headerSection.match(/^From:\s*(.*)$/mi);
      let from = "(No From)";
      if (fromMatch) {
        const rawFrom = decodeMimeWords(fromMatch[1].trim());
        const emailMatch = rawFrom.match(/(.*)<(.+?)>/);
        if (emailMatch) {
          const fromName = emailMatch[1].trim().replace(/\"/g, "");
          const fromEmail = emailMatch[2].trim();
          from = `${fromName} <${fromEmail}>`;
        } else { from = rawFrom; }
      }

      // Find boundary for multipart
      const boundaryMatch = content.match(/boundary=\"?([^\";]+)\"?/i);
      let html = "", text = "", attachments = {};
      if (boundaryMatch) {
        const boundary = boundaryMatch[1];
        const parts = parseMimeParts(content, boundary);

        parts.forEach(p => {
          const ctype = p.headers["content-type"] || "";
          const encoding = (p.headers["content-transfer-encoding"] || "").toLowerCase();
          if (ctype.includes("text/html")) {
            html = (encoding === "quoted-printable") ? decodeQuotedPrintable(p.body) : p.body;
          } else if (ctype.includes("text/plain")) {
            text = (encoding === "quoted-printable") ? decodeQuotedPrintable(p.body) : p.body;
          } else if (ctype.startsWith("image/") && p.headers["content-id"]) {
            const cid = p.headers["content-id"].replace(/[<>]/g, "");
            const base64Data = p.body.replace(/\s+/g, "");
            attachments[cid] = `data:${ctype};base64,${base64Data}`;
          }
        });
      }

      // Replace cid images
      if (html) {
        html = html.replace(/src=["']cid:([^"'>]+)["']/g, (match, cid) => {
          return attachments[cid] ? `src="${attachments[cid]}"` : match;
        });
      }

      return {
        subject,
        from,
        body: html || `<pre>${text}</pre>` || "<p>(No content)</p>",
        filename,
        type: answerKey[filename] || "phish",
        explanation: `This email (${filename}) was marked as ${answerKey[filename] || "phish"}.`,
        isHtml: !!html
      };
    }

    async function loadEmails() {
      let loaded = 0;
      for (let filename of emailFiles) {
        try {
          const response = await fetch(`emails/${filename}`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const content = await response.text();
          emails.push(parseEml(content, filename));
          loaded++;
        } catch (err) {
          console.error("Failed to load", filename, err);
          document.getElementById("game").innerHTML +=
            `<div style="background:#fee; color:#900; padding:10px; margin-bottom:10px; border:1px solid #c00;">
              ‚ùå Could not load <strong>${filename}</strong>: ${err.message}
            </div>`;
        }
      }
      if (loaded > 0) showEmail();
      else document.getElementById("game").innerHTML +=
        `<div style="background:#ffe; color:#333; padding:10px; margin-top:20px; border:1px solid #cc0;">
          ‚ö†Ô∏è No emails could be loaded. Please check your /emails folder.
        </div>`;
    }

    function showEmail() {
      if (current >= emails.length) {
        document.getElementById("game").innerHTML = "<h2>Game Over!</h2>";
        document.getElementById("score").innerText = `Your final score: ${score}/${emails.length}`;
        return;
      }

      const email = emails[current];
      const iframeId = "emailFrame";

      document.getElementById("game").innerHTML = `
        <div class="card email-wrapper">
          <div class="email-header">
            <div class="avatar">SC</div>
            <div class="meta">
              <div class="from-line"><strong>${email.from}</strong></div>
              <div class="to-line">To: You</div>
            </div>
          </div>
          <div class="subject-line">${email.subject}</div>
          <iframe id="${iframeId}" class="email-body-frame"></iframe>
          <div class='buttons'>
            <button class='phish' onclick="guess('phish')">Phish üêü</button>
            <button class='legit' onclick="guess('legit')">Legit ‚úÖ</button>
          </div>
          <div id='feedback'></div>
        </div>`;

      const iframe = document.getElementById(iframeId);
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open();
      doc.write(email.body);
      doc.close();
    }

    function guess(choice) {
      const email = emails[current];
      const feedback = document.getElementById("feedback");
      if (choice === email.type) {
        score++;
        feedback.innerHTML = `<p style='color:green;'>Correct! ${email.explanation}</p>`;
      } else {
        feedback.innerHTML = `<p style='color:red;'>Incorrect. ${email.explanation}</p>`;
      }
      current++;
      setTimeout(showEmail, 2500);
      document.getElementById("score").innerText = `Score: ${score}/${emails.length}`;
    }

    window.onload = loadEmails;
  </script>
</body>
</html>
